name: Notify When Branch is Merged

on:
  merge_group: 
    branches: 
      - main
      - beta
  pull_request:
    types: [opened, closed, reopened]

jobs:
  msg:
    name: Sending Message
    runs-on: ubuntu-latest
    steps:
      - name: Set PR Info
        id: pr_info
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "PR_CREATOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
          echo "PR_CREATOR_IMAGE=${{ github.event.pull_request.user.avatar_url }}" >> $GITHUB_ENV
          echo "PR_STATE=${{ github.event.pull_request.state }}" >> $GITHUB_ENV
          echo "PR_URL=https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "REPO=${{ github.repository }}" >> $GITHUB_ENV
          echo "PR_FROM_BRANCH=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
          echo "PR_TO_BRANCH=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          echo "TIME=$(TZ=America/Argentina/Buenos_Aires date +'%a, %d %b %Y %H:%M')" >> $GITHUB_ENV
          if [ "${{ github.event.pull_request.state }}" = "open" ]; then
            echo "PR_STATE_EMOJI=ðŸŸ¢" >> $GITHUB_ENV
          elif [ "${{ github.event.pull_request.state }}" = "closed" ]; then
            echo "PR_STATE_EMOJI=ðŸ”´" >> $GITHUB_ENV
          elif [ "${{ github.event.pull_request.state }}" = "reopened" ]; then
            echo "PR_STATE_EMOJI=ðŸŸ " >> $GITHUB_ENV
          fi

      - name: Send PR Message to Slack
        if: github.event_name == 'pull_request'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Pull Request Notification from GitHub*"
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "image",
                    "image_url": "${{ env.PR_CREATOR_IMAGE }}",
                    "alt_text": "github user image"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*${{ env.PR_CREATOR }}* created a new pull request in *${{ env.REPO }}*"
                  }
                ]
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n${{ env.REPO }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*PR ID:*\n<${{ env.PR_URL }}|#${{ env.PR_NUMBER }}>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Title:*\n${{ env.PR_TITLE }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*State:*\n${{ env.PR_STATE }} ${{ env.PR_STATE_EMOJI }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Time:*\n${{ env.TIME }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*From:*\n${{ env.PR_FROM_BRANCH }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*To:*\n${{ env.PR_TO_BRANCH }}"
                  }
                ]
              }
            ]
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
